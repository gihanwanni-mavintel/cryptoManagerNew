# Crypto Position Manager

A complete crypto trading system that automatically listens to Telegram channels for trading signals, executes trades on Binance Futures, and provides a dashboard for managing positions.

## ğŸš€ Quick Links

- **[Quick Start Guide](./QUICKSTART.md)** - Get running in 5 minutes
- **[Full Setup Guide](./SETUP.md)** - Detailed setup and deployment instructions
- **[Deployment Checklist](./DEPLOYMENT_CHECKLIST.md)** - Pre-deployment verification

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Group â”‚â”€â”€â”€â”€â–¶â”‚  Python FastAPI â”‚â”€â”€â”€â”€â–¶â”‚  Binance FAPI   â”‚
â”‚   (Signals)     â”‚     â”‚    (Backend)    â”‚     â”‚   (Exchange)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js UI    â”‚â”€â”€â”€â”€â–¶â”‚   PostgreSQL    â”‚
â”‚   (Frontend)    â”‚     â”‚  (Neon Cloud)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ Features

- **Automatic Telegram Listening**: Monitors Telegram groups for trading signals using Telethon
- **Manual Signal Input**: Paste signals manually via the web UI
- **LIMIT Order Execution**: Places limit orders at signal entry price on Binance Futures
- **Auto SL/TP Calculation**:
  - LONG: SL at -5%, TP at +2.5%
  - SHORT: SL at +5%, TP at -2.5%
- **Position Management**: View and close active positions with real-time P&L
- **Risk Management**: Configure leverage (default 20x), position size (default $1000), and margin mode
- **Database Tracking**: All signals and trades stored in PostgreSQL

## ğŸ›  Tech Stack

- **Frontend**: Next.js 14, TypeScript, Tailwind CSS, Radix UI
- **Backend**: Python 3.11+, FastAPI, SQLAlchemy, Telethon, python-binance
- **Database**: PostgreSQL (Neon Cloud)
- **Exchange**: Binance Futures API (LIVE mode)

## âš¡ Quick Start

**For detailed instructions, see [SETUP.md](./SETUP.md)**

### 1. Database Setup (Neon Cloud)

The database connection is already configured. Run these SQL commands in your Neon SQL editor if tables don't exist:

```sql
-- Users table
CREATE TABLE IF NOT EXISTS users (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(255) NOT NULL DEFAULT 'USER',
    CONSTRAINT users_role_check CHECK (role IN ('ADMIN', 'USER'))
);

-- Market messages table (raw Telegram messages)
CREATE TABLE IF NOT EXISTS market_messages (
    id SERIAL PRIMARY KEY,
    sender TEXT,
    text TEXT,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Signal messages table (parsed signals)
CREATE TABLE IF NOT EXISTS signal_messages (
    id BIGSERIAL PRIMARY KEY,
    pair VARCHAR(255),
    setup_type VARCHAR(255),
    entry DOUBLE PRECISION,
    stop_loss DOUBLE PRECISION,
    take_profit DOUBLE PRECISION,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    full_message TEXT,
    channel VARCHAR(255)
);

-- Trades table
CREATE TABLE IF NOT EXISTS trades (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    signal_id BIGINT,
    pair VARCHAR(255) NOT NULL,
    side VARCHAR(255) NOT NULL,
    leverage INTEGER DEFAULT 20,
    entry_price DOUBLE PRECISION,
    entry_quantity DOUBLE PRECISION,
    stop_loss DOUBLE PRECISION,
    take_profit DOUBLE PRECISION,
    tp DOUBLE PRECISION,
    status VARCHAR(255) DEFAULT 'PENDING',
    binance_order_id VARCHAR(255),
    binance_position_id VARCHAR(255),
    opened_at TIMESTAMP WITH TIME ZONE,
    closed_at TIMESTAMP WITH TIME ZONE,
    exit_price DOUBLE PRECISION,
    pnl DOUBLE PRECISION,
    pnl_percent DOUBLE PRECISION,
    exit_reason VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Trade management config table
CREATE TABLE IF NOT EXISTS trade_management_config (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    margin_mode VARCHAR(255) NOT NULL DEFAULT 'CROSSED',
    max_leverage NUMERIC(5, 2) NOT NULL DEFAULT 20.00,
    max_position_size NUMERIC(15, 2) NOT NULL DEFAULT 50.00,
    sl_percentage NUMERIC(5, 2) NOT NULL DEFAULT 5.00,
    tp_percentage NUMERIC(5, 2) NOT NULL DEFAULT 2.50,
    auto_execute_trades BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_trades_user_id ON trades(user_id);
CREATE INDEX IF NOT EXISTS idx_trades_status ON trades(status);
CREATE INDEX IF NOT EXISTS idx_trades_pair ON trades(pair);
CREATE INDEX IF NOT EXISTS idx_trades_signal_id ON trades(signal_id);
CREATE INDEX IF NOT EXISTS idx_trades_opened_at ON trades(opened_at);

-- Insert default admin user (password: admin123)
INSERT INTO users (username, password, role) 
VALUES ('admin', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.S8fSxBaKsqJLi', 'ADMIN')
ON CONFLICT (username) DO NOTHING;

-- Insert default trade config for admin (user_id = 1)
INSERT INTO trade_management_config (user_id, margin_mode, max_leverage, max_position_size)
VALUES (1, 'CROSSED', 20.00, 1000.00)
ON CONFLICT (user_id) DO NOTHING;
```

### 2. Backend Setup

```bash
cd backend
python -m venv venv
venv\Scripts\activate  # Windows: venv\Scripts\activate | Mac/Linux: source venv/bin/activate
pip install -r requirements.txt
copy .env.example .env  # Mac/Linux: cp .env.example .env
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

âœ… Backend: `http://localhost:8000` | Docs: `http://localhost:8000/docs`

### 3. Frontend Setup

```bash
cd frontend
npm install
copy .env.example .env.local  # Mac/Linux: cp .env.example .env.local
npm run dev
```

âœ… Frontend: `http://localhost:3000`

### 4. Test with a Signal

Open `http://localhost:3000` and paste:
```
#BTCUSDT P | LONG ğŸŸ¢
Entry: 42000 (CMP)
TP 1 â†’ 43050
Stop Loss: 39900 â˜ ï¸
```

Check **Active Positions** to see the trade!

## ğŸ“¦ Deployment

### Frontend to Vercel
```bash
cd frontend
npm install -g vercel
vercel login
vercel --prod
```
Add environment variable in Vercel: `NEXT_PUBLIC_API_URL` = your backend URL

### Backend to Digital Ocean
```bash
# On your droplet (Ubuntu 22.04)
apt update && apt upgrade -y
apt install -y python3.11 python3.11-venv nginx supervisor git

mkdir -p /var/www/crypto-backend
cd /var/www/crypto-backend
# Upload your backend files

python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Configure supervisor and nginx (see SETUP.md for details)
```

**See [SETUP.md](./SETUP.md) for complete deployment instructions.**

## âš™ï¸ Configuration

### Default Trading Settings

| Setting | Default | Description |
|---------|---------|-------------|
| Position Size | $1000 | Maximum USD per trade |
| Leverage | 20x | Futures leverage multiplier |
| Stop Loss | 5% | Distance from entry |
| Take Profit | 2.5% | Distance from entry |
| Margin Mode | CROSSED | Uses full account balance |
| Order Type | LIMIT | Places at signal entry price |

**Change these in the Trade Management page in the UI.**

### Environment Variables

Key variables in `backend/.env`:
```env
DATABASE_URL=postgresql://...           # Neon Cloud PostgreSQL
BINANCE_API_KEY=...                     # Binance API
BINANCE_API_SECRET=...                  # Binance Secret
BINANCE_TESTNET=false                   # âš ï¸ LIVE TRADING
TELEGRAM_API_ID=...                     # Telegram App ID
TELEGRAM_API_HASH=...                   # Telegram Hash
TELEGRAM_SESSION_STRING=...             # Telegram Session
TELEGRAM_GROUP_ID=...                   # Group to monitor
DEFAULT_LEVERAGE=20                     # Default 20x
DEFAULT_POSITION_SIZE=1000              # Default $1000
DEFAULT_SL_PERCENTAGE=5.0               # 5% SL
DEFAULT_TP_PERCENTAGE=2.5               # 2.5% TP
```

## ğŸ”„ How It Works

### 1ï¸âƒ£ Signal Reception
- **Automatic**: Telegram listener monitors group for messages containing signals
- **Manual**: Paste signal text directly in the UI

### 2ï¸âƒ£ Signal Parsing
Extracts from message:
- Trading pair (e.g., METUSDT)
- Direction (LONG ğŸŸ¢ or SHORT ğŸ”´)
- Entry price

### 3ï¸âƒ£ SL/TP Calculation
- **LONG**:
  - SL = Entry Ã— 0.95 (5% below)
  - TP = Entry Ã— 1.025 (2.5% above)
- **SHORT**:
  - SL = Entry Ã— 1.05 (5% above)
  - TP = Entry Ã— 0.975 (2.5% below)

### 4ï¸âƒ£ Order Execution
1. **LIMIT order** placed at signal entry price
2. **Stop Loss** order placed (STOP_MARKET)
3. **Take Profit** order placed (TAKE_PROFIT_MARKET)

### 5ï¸âƒ£ Position Tracking
- Position synced with Binance
- Real-time P&L displayed
- Manual close available anytime

### Supported Signal Formats

```
#METUSDT P | LONG ğŸŸ¢
Entry: 0.2515 (CMP)
TP 1 â†’ 0.2573
Stop Loss: 0.25 â˜ ï¸
```

```
#BTCUSDT SHORT ğŸ”´
Entry: 42000
TP: 40950
SL: 44100
```

## API Endpoints

### Signals
- `POST /api/signals/parse` - Parse and execute a signal manually
- `GET /api/signals` - Get all parsed signals
- `GET /api/signals/active/count` - Get active signal count

### Trades
- `GET /api/trades/positions` - Get active positions
- `POST /api/trades/close/{trade_id}` - Close a position
- `GET /api/trades/pnl` - Get total P&L

### Configuration
- `GET /api/config` - Get trade configuration
- `PUT /api/config` - Update configuration
- `POST /api/config/reset` - Reset to defaults

### Telegram
- `GET /api/telegram/status` - Get Telegram listener status

## ğŸ“Š Database Schema

The system uses 5 main tables:

1. **users** - User accounts (default: admin/admin123)
2. **market_messages** - Raw Telegram messages
3. **signal_messages** - Parsed signal data
4. **trades** - All trade records with P&L
5. **trade_management_config** - User trading preferences

See database creation SQL in [SETUP.md](./SETUP.md)

## ğŸ” Security Notes

- âš ï¸ Never commit `.env` files to Git (added to `.gitignore`)
- ğŸ”‘ Rotate API keys regularly
- ğŸŒ Use IP restrictions on Binance API
- ğŸ”’ Enable 2FA on all accounts
- ğŸ“ Keep session strings private

## âš ï¸ Important Warnings

### LIVE TRADING
- This system is configured for **LIVE TRADING** (`BINANCE_TESTNET=false`)
- Real money is at risk
- Default position size is **$1000 per trade**
- Start with smaller amounts to test

### Risk Management
- Leverage trading is high risk
- Always monitor active positions
- Set appropriate position sizes
- Understand liquidation risk
- Have an emergency stop plan

### Monitoring
- Check logs regularly: `tail -f /var/log/crypto-backend.out.log`
- Monitor Binance account balance
- Track open positions
- Set up alerts for large losses

## ğŸ› Troubleshooting

### Backend Issues
```bash
# Check status
supervisorctl status

# View logs
tail -f /var/log/crypto-backend.out.log
tail -f /var/log/crypto-backend.err.log

# Restart
supervisorctl restart crypto-backend
```

### Frontend Issues
```bash
# View Vercel logs
vercel logs

# Redeploy
vercel --prod
```

### Common Issues
| Issue | Solution |
|-------|----------|
| Telegram listener not starting | Check `TELEGRAM_SESSION_STRING` and `GROUP_ID` |
| Orders not executing | Verify Binance API has Futures enabled |
| Database errors | Check Neon Cloud connection string |
| CORS errors | Update allowed origins in `main.py` |

## ğŸ“š API Documentation

Once running, visit:
- **API Docs**: `http://localhost:8000/docs`
- **Health Check**: `http://localhost:8000/health`
- **Telegram Status**: `http://localhost:8000/api/telegram/status`

## ğŸ¤ Support

For issues or questions:
1. Check [SETUP.md](./SETUP.md) for setup help
2. Review [DEPLOYMENT_CHECKLIST.md](./DEPLOYMENT_CHECKLIST.md) before deploying
3. Check backend logs for errors
4. Verify all environment variables are set

## ğŸ“„ License

MIT License
#   c r y p t o M a n a g e r N e w  
 