# Crypto Position Manager - Setup & Deployment Guide

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Local Development Setup](#local-development-setup)
3. [Deploy Frontend to Vercel](#deploy-frontend-to-vercel)
4. [Deploy Backend to Digital Ocean](#deploy-backend-to-digital-ocean)
5. [Post-Deployment Configuration](#post-deployment-configuration)
6. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Software Requirements
- **Python 3.11+** - [Download](https://www.python.org/downloads/)
- **Node.js 18+** - [Download](https://nodejs.org/)
- **Git** - [Download](https://git-scm.com/)
- **PostgreSQL** (via Neon Cloud - already configured)

### API Keys Required
You already have these configured in the `.env.example` file:
- ‚úÖ Binance API Key & Secret (Live mode)
- ‚úÖ Telegram API credentials
- ‚úÖ Neon Database connection string

---

## Local Development Setup

### 1. Clone the Repository
```bash
# If not already in the project directory
cd crypto_position_manager
```

### 2. Database Setup (Neon Cloud)

Your database is already configured! The connection string is in `backend/.env.example`.

**Create the database tables** (if not already created):

1. Go to [Neon Console](https://console.neon.tech/)
2. Select your database
3. Open **SQL Editor**
4. Run the following SQL:

```sql
-- Users table
CREATE TABLE IF NOT EXISTS users (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(255) NOT NULL DEFAULT 'USER',
    CONSTRAINT users_role_check CHECK (role IN ('ADMIN', 'USER'))
);

-- Market messages table (raw Telegram messages)
CREATE TABLE IF NOT EXISTS market_messages (
    id SERIAL PRIMARY KEY,
    sender TEXT,
    text TEXT,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Signal messages table (parsed signals)
CREATE TABLE IF NOT EXISTS signal_messages (
    id BIGSERIAL PRIMARY KEY,
    pair VARCHAR(255),
    setup_type VARCHAR(255),
    entry DOUBLE PRECISION,
    stop_loss DOUBLE PRECISION,
    take_profit DOUBLE PRECISION,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    full_message TEXT,
    channel VARCHAR(255)
);

-- Trades table
CREATE TABLE IF NOT EXISTS trades (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    signal_id BIGINT,
    pair VARCHAR(255) NOT NULL,
    side VARCHAR(255) NOT NULL,
    leverage INTEGER DEFAULT 20,
    entry_price DOUBLE PRECISION,
    entry_quantity DOUBLE PRECISION,
    stop_loss DOUBLE PRECISION,
    take_profit DOUBLE PRECISION,
    tp DOUBLE PRECISION,
    status VARCHAR(255) DEFAULT 'PENDING',
    binance_order_id VARCHAR(255),
    binance_position_id VARCHAR(255),
    opened_at TIMESTAMP WITH TIME ZONE,
    closed_at TIMESTAMP WITH TIME ZONE,
    exit_price DOUBLE PRECISION,
    pnl DOUBLE PRECISION,
    pnl_percent DOUBLE PRECISION,
    exit_reason VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Trade management config table
CREATE TABLE IF NOT EXISTS trade_management_config (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    margin_mode VARCHAR(255) NOT NULL DEFAULT 'CROSSED',
    max_leverage NUMERIC(5, 2) NOT NULL DEFAULT 20.00,
    max_position_size NUMERIC(15, 2) NOT NULL DEFAULT 1000.00,
    sl_percentage NUMERIC(5, 2) NOT NULL DEFAULT 5.00,
    tp_percentage NUMERIC(5, 2) NOT NULL DEFAULT 2.50,
    auto_execute_trades BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_trades_user_id ON trades(user_id);
CREATE INDEX IF NOT EXISTS idx_trades_status ON trades(status);
CREATE INDEX IF NOT EXISTS idx_trades_pair ON trades(pair);
CREATE INDEX IF NOT EXISTS idx_trades_signal_id ON trades(signal_id);
CREATE INDEX IF NOT EXISTS idx_trades_opened_at ON trades(opened_at);

-- Insert default admin user (password: admin123)
INSERT INTO users (username, password, role)
VALUES ('admin', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.S8fSxBaKsqJLiq', 'ADMIN')
ON CONFLICT (username) DO NOTHING;

-- Insert default trade config for admin (user_id = 1)
INSERT INTO trade_management_config (user_id, margin_mode, max_leverage, max_position_size)
VALUES (1, 'CROSSED', 20.00, 1000.00)
ON CONFLICT (user_id) DO NOTHING;
```

### 3. Backend Setup

```bash
# Navigate to backend directory
cd backend

# Create virtual environment
python -m venv venv

# Activate virtual environment
# On Windows:
venv\Scripts\activate
# On Mac/Linux:
# source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Copy environment variables (your credentials are already there)
copy .env.example .env

# Verify your .env file has these settings:
# DATABASE_URL=postgresql://neondb_owner:...
# BINANCE_API_KEY=your_key
# BINANCE_API_SECRET=your_secret
# BINANCE_TESTNET=false  # IMPORTANT: This is LIVE trading!
# TELEGRAM_API_ID=26883812
# TELEGRAM_API_HASH=...
# TELEGRAM_SESSION_STRING=...
# TELEGRAM_GROUP_ID=-4888908773
# DEFAULT_LEVERAGE=20
# DEFAULT_POSITION_SIZE=1000
# DEFAULT_SL_PERCENTAGE=5.0
# DEFAULT_TP_PERCENTAGE=2.5
# DEFAULT_MARGIN_MODE=CROSSED

# Start the backend server
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Backend will be running at: **http://localhost:8000**
- API docs: **http://localhost:8000/docs**
- Health check: **http://localhost:8000/health**

### 4. Frontend Setup

Open a **new terminal** (keep backend running):

```bash
# Navigate to frontend directory
cd frontend

# Install dependencies
npm install

# Copy environment variables
copy .env.example .env.local

# Edit .env.local to have:
# NEXT_PUBLIC_API_URL=http://localhost:8000

# Start the development server
npm run dev
```

Frontend will be running at: **http://localhost:3000**

### 5. Verify Everything Works

1. **Open browser**: http://localhost:3000
2. **Check backend logs** - you should see:
   - "Telegram listener task created"
   - "Binance service initialized"
3. **Test manual signal** - paste a signal in the UI
4. **Check active positions** - verify Binance positions show up

---

## Deploy Frontend to Vercel

### Step 1: Prepare Frontend for Deployment

```bash
cd frontend

# Ensure package.json has correct build script (already configured)
# "build": "next build"
# "start": "next start"
```

### Step 2: Deploy to Vercel

#### Option A: Using Vercel CLI (Recommended)

```bash
# Install Vercel CLI globally
npm install -g vercel

# Login to Vercel
vercel login

# Deploy (from frontend directory)
vercel

# Follow the prompts:
# - Set up and deploy? Yes
# - Which scope? Select your account
# - Link to existing project? No
# - Project name? crypto-position-manager
# - Directory? ./
# - Override settings? No

# After successful deployment, deploy to production
vercel --prod
```

#### Option B: Using Vercel Dashboard

1. Go to [vercel.com](https://vercel.com) and sign in
2. Click **"Add New Project"**
3. **Import your Git repository**:
   - Connect your GitHub/GitLab/Bitbucket
   - Select the `crypto_position_manager` repository
4. **Configure project**:
   - **Framework Preset**: Next.js
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `.next`
5. **Add Environment Variables**:
   - Key: `NEXT_PUBLIC_API_URL`
   - Value: `https://your-backend-domain.com` (you'll update this after backend deployment)
6. Click **"Deploy"**

### Step 3: Get Vercel Deployment URL

After deployment completes, you'll get a URL like:
```
https://crypto-position-manager.vercel.app
```

**Save this URL** - you'll need it for CORS configuration on the backend.

---

## Deploy Backend to Digital Ocean

### Step 1: Create a Digital Ocean Droplet

1. **Sign in to Digital Ocean**: [digitalocean.com](https://www.digitalocean.com)
2. **Create a new Droplet**:
   - Click **"Create"** ‚Üí **"Droplets"**
   - **Image**: Ubuntu 22.04 LTS
   - **Plan**: Basic ($6/month - 1GB RAM, 1 vCPU)
   - **Datacenter**: Choose closest to you (e.g., Singapore)
   - **Authentication**: SSH keys (or password)
   - **Hostname**: `crypto-trading-bot`
   - Click **"Create Droplet"**

3. **Note your Droplet's IP address** (e.g., `157.245.xxx.xxx`)

### Step 2: Connect to Your Droplet

```bash
# SSH into your droplet (replace with your IP)
ssh root@157.245.xxx.xxx

# Update system packages
apt update && apt upgrade -y
```

### Step 3: Install Required Software

```bash
# Install Python 3.11
apt install -y python3.11 python3.11-venv python3-pip

# Install Nginx (reverse proxy)
apt install -y nginx

# Install Supervisor (process manager)
apt install -y supervisor

# Install Git
apt install -y git
```

### Step 4: Clone and Setup Backend

```bash
# Create app directory
mkdir -p /var/www/crypto-backend
cd /var/www/crypto-backend

# Clone your repository (or upload files)
# Option 1: If you have a Git repo
git clone https://github.com/yourusername/crypto_position_manager.git .

# Option 2: Upload files manually using SCP (from your local machine)
# scp -r backend/* root@157.245.xxx.xxx:/var/www/crypto-backend/

# Navigate to backend directory
cd backend  # if you cloned the full repo
# OR stay in /var/www/crypto-backend if you uploaded backend files directly

# Create virtual environment
python3.11 -m venv venv

# Activate virtual environment
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt
```

### Step 5: Configure Environment Variables

```bash
# Create .env file
nano .env
```

Paste your environment variables:
```env
# Database (Neon Cloud)
DATABASE_URL=postgresql://neondb_owner:npg_Xz4BASnmv8yl@ep-lingering-pond-a1jm0v0d-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

# Binance API
BINANCE_API_KEY=1pxvUspdYb2iO8kla5ul2C1Un9ZxV0YOneUhvFgGN0nCvc5TlXhG8yzl01e75ykk
BINANCE_API_SECRET=MVRmZg2vhOV7ExbcTcEibm5XK83gftompPLl19SETB8AzTBDjZ0zETBKaeEIrGW2
BINANCE_TESTNET=false

# Telegram
TELEGRAM_API_ID=26883812
TELEGRAM_API_HASH=4e05a57633f9c55768f50bcbd6a9b5f8
TELEGRAM_SESSION_STRING=1BVtsOLwBu4XkwRq6-FWom1N8QRLRAU-SJ2w2xWquT_AII_CcHnAmxYr8Kd1PE3NNZvIFvOl7Hnuxo8fpwkmB_T1eDjlmoxGknicn1oAGmY4N0fGXVTfderWCGZGAFlhSymcPZT1E-DaH3WkNT6he-DouDHEur4Z-cHqf-OvHoORicjHR7BgmK7R5dmw3rOCgrsMiYYf6BW6qES4smPTubjclORoM_r58Tsp-HMwVNbdA7SRnAY26Kd6yb3RJI4pOiHDwuKChnCvN6Xdq9QiuYX7IaNE3MkHU6ibCXjJx4B0DiL-MqGJlQb8E5DBjTzIM7TPRbOVrffHKBB2xViZvhni8sKOAdKk=
TELEGRAM_GROUP_ID=-4888908773

# JWT
SECRET_KEY=crypto-position-manager-super-secret-key-change-this-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# Trade Settings
DEFAULT_LEVERAGE=20
DEFAULT_POSITION_SIZE=1000
DEFAULT_SL_PERCENTAGE=5.0
DEFAULT_TP_PERCENTAGE=2.5
DEFAULT_MARGIN_MODE=CROSSED
AUTO_EXECUTE_TRADES=true
DEFAULT_USER_ID=1
```

Save and exit (Ctrl+X, then Y, then Enter)

### Step 6: Configure Supervisor (Keep Backend Running)

```bash
# Create supervisor config
nano /etc/supervisor/conf.d/crypto-backend.conf
```

Paste this configuration:
```ini
[program:crypto-backend]
directory=/var/www/crypto-backend/backend
command=/var/www/crypto-backend/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
autostart=true
autorestart=true
stderr_logfile=/var/log/crypto-backend.err.log
stdout_logfile=/var/log/crypto-backend.out.log
user=root
environment=HOME="/root",USER="root"
```

Adjust the paths if you uploaded files differently:
- If you cloned the full repo: `directory=/var/www/crypto-backend/backend`
- If you uploaded backend files only: `directory=/var/www/crypto-backend`

Save and exit (Ctrl+X, then Y, then Enter)

```bash
# Update supervisor
supervisorctl reread
supervisorctl update

# Start the application
supervisorctl start crypto-backend

# Check status
supervisorctl status

# View logs
tail -f /var/log/crypto-backend.out.log
```

### Step 7: Configure Nginx (Reverse Proxy)

```bash
# Create Nginx config
nano /etc/nginx/sites-available/crypto-backend
```

Paste this configuration:
```nginx
server {
    listen 80;
    server_name 157.245.xxx.xxx;  # Replace with your Droplet IP

    client_max_body_size 10M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (for future features)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

Replace `157.245.xxx.xxx` with your actual Droplet IP address.

```bash
# Enable the site
ln -s /etc/nginx/sites-available/crypto-backend /etc/nginx/sites-enabled/

# Remove default site
rm /etc/nginx/sites-enabled/default

# Test Nginx configuration
nginx -t

# Restart Nginx
systemctl restart nginx

# Enable Nginx to start on boot
systemctl enable nginx
```

### Step 8: Configure Firewall

```bash
# Allow SSH, HTTP, and HTTPS
ufw allow OpenSSH
ufw allow 'Nginx Full'
ufw enable

# Check status
ufw status
```

### Step 9: Test Backend Deployment

```bash
# Check if backend is running
curl http://localhost:8000/health

# Check from outside
curl http://157.245.xxx.xxx/health
```

You should see:
```json
{
  "status": "healthy",
  "binance_testnet": false,
  "telegram_listener": true,
  "auto_execute": true,
  "position_size": 1000
}
```

### Step 10: (Optional) Setup SSL with Let's Encrypt

**If you have a domain name** (e.g., `api.yoursite.com`):

```bash
# Install Certbot
apt install -y certbot python3-certbot-nginx

# Point your domain to your Droplet IP
# Update your domain's A record to point to: 157.245.xxx.xxx

# Get SSL certificate
certbot --nginx -d api.yoursite.com

# Follow the prompts
# Certificate will auto-renew
```

Update Nginx config to use your domain:
```bash
nano /etc/nginx/sites-available/crypto-backend
```

Change `server_name` to your domain:
```nginx
server_name api.yoursite.com;
```

```bash
nginx -t
systemctl reload nginx
```

Your backend is now at: **https://api.yoursite.com**

---

## Post-Deployment Configuration

### 1. Update Frontend Environment Variables

Go back to **Vercel Dashboard**:
1. Select your project
2. Go to **Settings** ‚Üí **Environment Variables**
3. Update `NEXT_PUBLIC_API_URL`:
   - **Without SSL**: `http://157.245.xxx.xxx`
   - **With SSL**: `https://api.yoursite.com`
4. **Redeploy** the frontend:
   ```bash
   vercel --prod
   ```

### 2. Update Backend CORS Settings

SSH into your droplet:
```bash
ssh root@157.245.xxx.xxx
cd /var/www/crypto-backend/backend
nano app/main.py
```

Update the CORS origins to include your Vercel URL:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "https://crypto-position-manager.vercel.app",  # Add your Vercel URL
        "*",  # Remove this in production for better security
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

Restart the backend:
```bash
supervisorctl restart crypto-backend
```

### 3. Test End-to-End

1. **Open your Vercel URL**: `https://crypto-position-manager.vercel.app`
2. **Paste a test signal**:
   ```
   #BTCUSDT P | LONG üü¢
   Entry: 42000 (CMP)
   TP 1 ‚Üí 43050
   Stop Loss: 39900 ‚ò†Ô∏è
   ```
3. **Check if trade is placed** in Active Positions
4. **Verify in Binance** that the order was created

---

## Troubleshooting

### Backend Issues

**1. Backend not starting**
```bash
# Check logs
tail -f /var/log/crypto-backend.err.log

# Check supervisor status
supervisorctl status

# Restart backend
supervisorctl restart crypto-backend
```

**2. Database connection issues**
```bash
# Test database connection
cd /var/www/crypto-backend/backend
source venv/bin/activate
python -c "from app.database import engine; print(engine.connect())"
```

**3. Telegram listener not working**
```bash
# Check if session string is valid
# View logs
tail -f /var/log/crypto-backend.out.log | grep -i telegram
```

**4. Binance API errors**
```bash
# Test Binance connection
cd /var/www/crypto-backend/backend
source venv/bin/activate
python app/services/binance_service.py
```

### Frontend Issues

**1. API connection failed**
- Check `NEXT_PUBLIC_API_URL` in Vercel environment variables
- Ensure backend CORS allows your Vercel domain
- Check backend health: `curl https://your-backend/health`

**2. Build failures on Vercel**
- Check build logs in Vercel dashboard
- Ensure all dependencies are in `package.json`
- Try building locally first: `npm run build`

### Useful Commands

```bash
# Backend (on Digital Ocean)
supervisorctl status                    # Check backend status
supervisorctl restart crypto-backend   # Restart backend
tail -f /var/log/crypto-backend.out.log # View logs
systemctl status nginx                  # Check Nginx
nginx -t                                # Test Nginx config

# Frontend (Vercel)
vercel logs                            # View deployment logs
vercel --prod                          # Deploy to production

# Local Development
cd backend && uvicorn app.main:app --reload  # Run backend
cd frontend && npm run dev                   # Run frontend
```

---

## Production Checklist

- [ ] Database tables created in Neon
- [ ] Backend deployed to Digital Ocean
- [ ] Backend running via Supervisor
- [ ] Nginx configured and running
- [ ] Firewall configured (UFW)
- [ ] SSL certificate installed (if using domain)
- [ ] Frontend deployed to Vercel
- [ ] Environment variables updated
- [ ] CORS configured correctly
- [ ] Test signal processed successfully
- [ ] Binance orders executing correctly
- [ ] Telegram listener active
- [ ] Active positions displaying correctly

---

## Important Notes

‚ö†Ô∏è **LIVE TRADING WARNING**:
- `BINANCE_TESTNET=false` means this is **LIVE trading** with real money
- Default position size is **$1000 per trade**
- Start with smaller amounts to test
- Monitor your positions actively

üîê **Security**:
- Never commit `.env` files to Git
- Rotate API keys regularly
- Use strong passwords
- Keep SSH keys secure
- Update packages regularly

üìä **Monitoring**:
- Check logs regularly: `tail -f /var/log/crypto-backend.out.log`
- Monitor Binance account balance
- Set up alerts for large losses
- Keep track of open positions

---

## Support

If you encounter issues:
1. Check the logs (backend and frontend)
2. Verify all environment variables
3. Test API endpoints individually
4. Check Binance API status
5. Verify database connectivity

For Binance API docs: https://developers.binance.com/docs/binance-spot-api-docs/rest-api
For Vercel docs: https://vercel.com/docs
For Digital Ocean docs: https://docs.digitalocean.com/

---

**Deployment Complete!** üöÄ

Your crypto position manager is now live and ready to trade!
